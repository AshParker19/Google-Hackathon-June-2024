{% extends "base.html" %}

{% block title %}
Relatórios
{% endblock %}

{% block content %}
    <h2 class="text-center h1 pa-10 mx-5 my-5 report">Relatórios</h2>
<div class="d-flex flex-column align-items-center">
    {% for item in report_data %}
    <div class="rounded report-container d-flex align-items-center justify-content-between">
        <div class="image-container p-1">
            <img src="{{ url_for('static', filename='assets/testMap.png') }}" alt="Test Map" class="w-100 h-auto" id="reportImage">
        </div>
        <div class="w-75 p-3">
            <div class="p-1"><strong>ID:</strong> {{ item.id }}</div>
            <div class="p-1"><strong>Title:</strong> {{ item.title }}</div>
            <div class="p-1"><strong>Population Year:</strong> {{ item.popyear }}</div>
            <div class="p-1"><strong>ISO3:</strong> {{ item.iso3 }}</div>
        </div>
        <button class="rounded report-btn p-2 fs-6" data-id="{{ item.id }}" data-title="{{ item.title }}" data-popyear="{{ item.popyear }}" data-iso3="{{ item.iso3 }}">Descarregar</button>
    </div>
    {% endfor %}
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var buttons = document.querySelectorAll('.report-btn');

        buttons.forEach(function(button) {
            button.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                const title = this.getAttribute('data-title');
                const popyear = this.getAttribute('data-popyear');
                const iso3 = this.getAttribute('data-iso3');

                const reportData = {
                    id: id,
                    title: title,
                    popyear: popyear,
                    iso3: iso3
                };

                const imgElement = document.getElementById('reportImage');
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = imgElement.naturalWidth;
                canvas.height = imgElement.naturalHeight;
                ctx.drawImage(imgElement, 0, 0);

                const imageData = canvas.toDataURL('image/png');
                reportData.imageData = imageData;

                createAndDownloadPDF(reportData);
            });
        });
    });

    function createAndDownloadPDF(reportData) {
    const docDefinition = {
        content: [
            { text: 'Report', style: 'header' },
            {
                image: reportData.imageData,
                width: 300,
                alignment: 'center',
                margin: [0, 10, 0, 20]
            },
            { text: `ID: ${reportData.id}`, style: 'subheader' },
            { text: `Title: ${reportData.title}`, style: 'subheader' },
            { text: `Population Year: ${reportData.popyear}`, style: 'subheader' },
            { text: `ISO3: ${reportData.iso3}`, style: 'subheader' }
        ],
        styles: {
            header: {
                fontSize: 22,
                bold: true,
                margin: [0, 0, 0, 10],
                alignment: 'center'
            },
            subheader: {
                fontSize: 14,
                margin: [0, 10, 0, 10]
            },
            quote: {
                italics: true,
                alignment: 'right',
                margin: [0, 10, 0, 10]
            }
        }
    };

    pdfMake.createPdf(docDefinition).download('report.pdf');
}
/*
    function shareReport() {
        const shareData = {
            title: 'Report',
            text: 'Check out this report!',
            url: window.location.href
        };
        if (navigator.share) {
            navigator.share(shareData).then(() => {
                console.log('Report shared successfully.');
            }).catch((error) => {
                console.error('Error sharing report:', error);
            });
        } else {
            alert('Share not supported on this browser.');
        }
    }
*/  
</script>
{% endblock %}
