{% extends "base.html" %}

{% block title %}
Relatórios
{% endblock %}

{% block content %}
    <h2 class="text-center h1 pa-10 mx-5 my-5 report">Relatórios</h2>
<div class="bgr d-flex flex-column align-items-center">
    {% for item in report_data %}
    <div class="rounded report-container d-flex align-items-center justify-content-between">
        <div class="image-container p-1">
            <img src="{{ url_for('static', filename='assets/testMap.png') }}" alt="Test Map" class="w-100 h-auto" id="reportImage">
        </div>
        <div class="w-75 p-3">
            <div class="p-1"><strong>Location:</strong> {{ item.cards_table[0]['designacao'] }}</div>
            <div class="p-1"><strong>Created at:</strong> {{ item.created_at }}</div>
            <div class="p-1"><strong>Created by:</strong> {{ item.user }}</div>
        </div>
        <button class="rounded report-btn p-2 fs-6" data-created_at="{{ item.created_at }}" 
                                                    data-location="{{ item.cards_table[0]['designacao'] }}"
                                                    data-AI="{{ item.AI_insight }}" 
                                                    data-metric="{{ item.cards_table[0]['necessity_metric'] }}" 
                                                    data-email="{{ item.email }}" ">Descarregar</button>
    </div>
    {% endfor %}
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.70/vfs_fonts.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
    var buttons = document.querySelectorAll('.report-btn');

    buttons.forEach(function(button) {
        button.addEventListener('click', function() {
            const created_at = this.getAttribute('data-created_at');
            const location = this.getAttribute('data-location');
            const AI = this.getAttribute('data-AI');
            const metric = this.getAttribute('data-metric');
            const email = this.getAttribute('data-email');
            // const report = JSON.parse(this.getAttribute('data-report'));
            // const user = this.getAttribute('data-user');
            // const AI_insights = JSON.parse(this.getAttribute('data-AI_insights'));
            // const metrics = JSON.parse(this.getAttribute('data-metrics'));

            const reportData = {
                created_at: created_at,
                location: location,
                AI_insights: AI,
                metric: metric,
                email: email,
            };

            const imgElement = document.getElementById('reportImage');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = imgElement.naturalWidth;
            canvas.height = imgElement.naturalHeight;
            ctx.drawImage(imgElement, 0, 0);

            const imageData = canvas.toDataURL('image/png');
            reportData.imageData = imageData;

            createAndDownloadPDF(reportData);
        });
    });
});

function createAndDownloadPDF(reportData) {
    const docDefinition = {
        content: [
            { text: 'Report', style: 'header' },
            {
                image: reportData.imageData,
                width: 300,
                alignment: 'center',
                margin: [0, 10, 0, 20]
            },
            { text: 'Time: RAJH PHUYAL, PUT YOUR SHIT HERE', style: 'subheader' },
            { text: `Location: ${reportData.location}`, style: 'subheader' },
            { text: `AI Insights: ${reportData.AI_insights}`, style: 'subheader' },
            { text: `Metric: ${reportData.metric}`, style: 'subheader' },
            { text: `Created by: ${reportData.email}`, style: 'subheader'},
            { text: `Created at: ${reportData.created_at}`, style: 'subheader' }
        ],
        styles: {
            header: {
                fontSize: 22,
                bold: true,
                margin: [0, 0, 0, 10],
                alignment: 'center'
            },
            subheader: {
                fontSize: 14,
                margin: [0, 10, 0, 10]
            }
        }
    };

    pdfMake.createPdf(docDefinition).download('report.pdf');
}

</script>
{% endblock %}
